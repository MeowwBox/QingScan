{include file='public/head' /}
<div class="col-md-1 " style="padding-right: 0;" >
    {include file='public/asmLeftMenu' /}
</div>
<div class="col-md-11 " style="padding:0;">

<!-- 漏洞汇总列表 -->
<?php
$searchArr = [
    'action' =>  $_SERVER['REQUEST_URI'],
    'method' => 'get',
    'inputs' => [
        ['type' => 'text', 'name' => 'keyword', 'placeholder' => "漏洞名称/CVE/CNVD/IP地址"],
        ['type' => 'select', 'name' => 'severity', 'options' => $vul_severity, 'frist_option' => '漏洞严重程度'],
        ['type' => 'select', 'name' => 'status', 'options' => $vul_status, 'frist_option' => '漏洞状态']
    ]]; ?>
{include file='public/search' /}

<div class="row tuchu">
    <div class="col-md-12 ">
        <table class="table  table-hover">
            <thead class="table-light">
            <tr>
                <th>ID</th>
                <th>漏洞名称</th>
                <th>CVE编号</th>
                <th>CNVD编号</th>
                <th>IP地址</th>
                <th>严重程度</th>
                <th>状态</th>
                <th>创建时间</th>
                <th style="width: 200px">操作</th>
            </tr>
            </thead>
            <?php foreach ($list as $value) { ?>
                <tr>
                    <td><?php echo $value['id'] ?></td>
                    <td><?php echo $value['vul_name'] ?></td>
                    <td><?php echo $value['cve_id'] ?></td>
                    <td><?php echo $value['cnvd_id'] ?></td>
                    <td><?php echo $value['ip_address'] ?></td>
                    <td>
                        <span class="badge <?php 
                            switch($value['severity']) {
                                case 'critical': echo 'bg-danger bg-light text-danger'; break;
                                case 'high': echo 'bg-warning bg-light text-warning'; break;
                                case 'medium': echo 'bg-info bg-light text-info'; break;
                                case 'low': echo 'bg-success bg-light text-success'; break;
                                case 'info': echo 'bg-secondary bg-light text-secondary'; break;
                                default: echo 'bg-light text-dark';
                            }
                        ?>">
                            <?php echo $vul_severity[$value['severity']] ?? $value['severity'] ?>
                        </span>
                    </td>
                    <td>
                        <span class="badge <?php 
                            switch($value['status']) {
                                case 'open': echo 'bg-danger bg-light text-danger'; break;
                                case 'fixed': echo 'bg-success bg-light text-success'; break;
                                case 'ignored': echo 'bg-secondary bg-light text-secondary'; break;
                                default: echo 'bg-light text-dark';
                            }
                        ?>">
                            <?php echo $vul_status[$value['status']] ?? $value['status'] ?>
                        </span>
                    </td>
                    <td><?php echo $value['created_at'] ?></td>
                    <td>
                        <a href="javascript:void(0)" class="btn btn-sm btn-outline-primary" onclick="createWorkOrder(<?php echo $value['id'] ?>, 'vul')">创建工单</a>
                    </td>
                </tr>
            <?php } ?>
        </table>
    </div>
</div>

{include file='public/fenye' /}</div>
<script>
function createWorkOrder(id, type) {
    $.ajax({
        url: '<?php echo url('asm/vulnerability/createWorkOrder') ?>',
        type: 'post',
        data: {id: id, type: type},
        dataType: 'json',
        success: function(res) {
            if (res.code == 1) {
                alert(res.msg);
                window.location.href = res.url;
            } else {
                alert(res.msg);
            }
        }
    });
}
</script>
{include file='public/footer' /}