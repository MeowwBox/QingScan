<?php

namespace app\asm\controller;

use app\asm\model\VulnerabilityModel;
use app\controller\Common;
use think\facade\View;
use think\facade\Db;
use think\facade\Request;

class Vulnerability extends Common
{
    // 漏洞汇总列表
    public function index()
    {
        // 获取搜索条件
        $keyword = Request::param('keyword', '');
        $severity = Request::param('severity', '');
        $status = Request::param('status', '');
        
        // 构建查询条件
        $where = [];
        if (!empty($keyword)) {
            $where[] = ['vul_name|cve_id|cnvd_id|ip_address', 'like', '%' . $keyword . '%'];
        }
        if (!empty($severity)) {
            $where['severity'] = $severity;
        }
        if (!empty($status)) {
            $where['status'] = $status;
        }
        
        // 获取分页参数
        $page = Request::param('page', 1, 'intval');
        $limit = Request::param('limit', 20, 'intval');
        
        // 获取数据
        $vul_page = Db::table('asm_vulnerability_summary')
            ->where($where)
            ->order('updated_at desc')
            ->paginate([
                'list_rows' => $limit,
                'page' => $page,
                'query' => Request::param()
            ]);
        
        // 获取分页数据列表
        $list = $vul_page->items();
        
        // 漏洞状态
        $vul_status = [
            'open' => '未修复',
            'fixed' => '已修复',
            'ignored' => '已忽略'
        ];
        
        // 漏洞严重程度
        $vul_severity = [
            'critical' => '紧急',
            'high' => '高危',
            'medium' => '中危',
            'low' => '低危',
            'info' => '信息'
        ];
        
        View::assign([
            'list' => $list,
            'page' => $vul_page,
            'vul_status' => $vul_status,
            'vul_severity' => $vul_severity,
            'keyword' => $keyword,
            'severity' => $severity,
            'status' => $status
        ]);
        
        return View::fetch();
    }
    
    // 青藤云主机漏洞列表
    public function qingteng()
    {
        // 获取搜索条件
        $keyword = Request::param('keyword', '');
        $severity = Request::param('severity', '');
        $status = Request::param('status', '');
        $ip = Request::param('ip', '');
        
        // 构建查询条件
        $where = [];
        if (!empty($keyword)) {
            $where[] = ['vul_name|vul_id|cve_id|title', 'like', '%' . $keyword . '%'];
        }
        if (!empty($severity)) {
            $where['severity'] = $severity;
        }
        if (!empty($status)) {
            $where['status'] = $status;
        }
        if (!empty($ip)) {
            $where['ip'] = $ip;
        }
        
        // 获取分页参数
        $page = Request::param('page', 1, 'intval');
        $limit = Request::param('limit', 20, 'intval');
        
        // 获取数据
        $vul_page = Db::table('asm_vulnerability_qingteng')
            ->where($where)
            ->order('updated_at desc')
            ->paginate([
                'list_rows' => $limit,
                'page' => $page,
                'query' => Request::param()
            ]);
        
        // 获取分页数据列表
        $list = $vul_page->items();
        
        // 漏洞状态
        $vul_status = [
            'pending' => '处理中',
            'fixed' => '已修复',
            'ignored' => '已忽略'
        ];
        
        // 漏洞严重程度
        $vul_severity = [
            'SEVERITY_CRITICAL' => '紧急',
            'SEVERITY_HIGH' => '高危',
            'SEVERITY_MEDIUM' => '中危',
            'SEVERITY_LOW' => '低危'
        ];
        
        View::assign([
            'list' => $list,
            'page' => $vul_page,
            'vul_status' => $vul_status,
            'vul_severity' => $vul_severity,
            'keyword' => $keyword,
            'ip' => $ip,
            'status' => $status
        ]);
        
        return View::fetch();
    }
    
    // 创建工单
    public function createWorkOrder()
    {
        $id = Request::param('id', 0, 'intval');
        $type = Request::param('type', '');
        
        if (empty($id) || empty($type)) {
            return json(['code' => 0, 'msg' => '参数错误']);
        }
        
        // 获取漏洞信息
        $vul_data = [];
        if ($type == 'vul') {
            $vul_data = Db::table('asm_vulnerability_summary')->where('id', $id)->find();
        } elseif ($type == 'qingteng') {
            $vul_data = Db::table('asm_vulnerability_qingteng')->where('id', $id)->find();
        }
        
        if (empty($vul_data)) {
            return json(['code' => 0, 'msg' => '漏洞信息不存在']);
        }
        
        // 构建工单数据
        $ip_field = ($type == 'qingteng') ? 'ip' : 'ip_address';
        $work_order_data = [
            'title' => '漏洞修复工单：' . $vul_data['vul_name'],
            'content' => '发现漏洞：' . $vul_data['vul_name'] . '，IP地址：' . $vul_data[$ip_field] . '，严重程度：' . $vul_data['severity'],
            'vul_id' => $id,
            'vul_type' => $type,
            'status' => 'open',
            'created_at' => date('Y-m-d H:i:s'),
            'updated_at' => date('Y-m-d H:i:s')
        ];
        
        // 保存工单
        $work_order_id = Db::table('asm_work_order')->insertGetId($work_order_data);
        
        if ($work_order_id) {
            return json(['code' => 1, 'msg' => '工单创建成功', 'url' => url('/asm/workorder/index')]);
        } else {
            return json(['code' => 0, 'msg' => '工单创建失败']);
        }
    }
}