<?php

namespace app\asm\model;

use app\model\BaseModel;
use think\console\Output;
use think\facade\Db;

class VulnerabilityModel extends BaseModel
{
    // 获取漏洞列表
    public static function getVulnerabilities($where = [], $page = 1, $limit = 20)
    {
        return Db::table('asm_vulnerability_summary')
            ->where($where)
            ->order('updated_at desc')
            ->page($page, $limit)
            ->select();
    }
    
    // 获取漏洞总数
    public static function getVulnerabilitiesCount($where = [])
    {
        return Db::table('asm_vulnerability_summary')->where($where)->count();
    }
    
    // 根据ID获取漏洞
    public static function getVulnerabilityById($id)
    {
        return Db::table('asm_vulnerability_summary')->where('id', $id)->find();
    }
    
    // 添加漏洞
    public static function addVulnerability($data)
    {
        return Db::table('asm_vulnerability_summary')->insertGetId($data);
    }
    
    // 更新漏洞
    public static function updateVulnerability($id, $data)
    {
        return Db::table('asm_vulnerability_summary')->where('id', $id)->update($data);
    }
    
    // 删除漏洞
    public static function deleteVulnerability($id)
    {
        return Db::table('asm_vulnerability_summary')->where('id', $id)->delete();
    }
    
    // 获取青藤漏洞列表
    public static function getQingtengVulnerabilities($where = [], $page = 1, $limit = 20)
    {
        return Db::table('asm_vulnerability_qingteng')
            ->where($where)
            ->order('updated_at desc')
            ->page($page, $limit)
            ->select();
    }
    
    // 获取青藤漏洞总数
    public static function getQingtengVulnerabilitiesCount($where = [])
    {
        return Db::table('asm_vulnerability_qingteng')->where($where)->count();
    }
    
    // 根据ID获取青藤漏洞
    public static function getQingtengVulnerabilityById($id)
    {
        return Db::table('asm_vulnerability_qingteng')->where('id', $id)->find();
    }
    
    // 添加青藤漏洞
    public static function addQingtengVulnerability($data)
    {
        return Db::table('asm_vulnerability_qingteng')->insertGetId($data);
    }
    
    // 更新青藤漏洞
    public static function updateQingtengVulnerability($id, $data)
    {
        return Db::table('asm_vulnerability_qingteng')->where('id', $id)->update($data);
    }
    
    // 删除青藤漏洞
    public static function deleteQingtengVulnerability($id)
    {
        return Db::table('asm_vulnerability_qingteng')->where('id', $id)->delete();
    }
    
    /**
     * 从静态JSON文件导入青藤云漏洞数据
     */
    public static function importFromStaticJson(Output $output, string $jsonFilePath): void
    {
        $output->writeln("正在从静态JSON文件导入青藤云漏洞数据...");
        
        // 检查文件是否存在
        if (!file_exists($jsonFilePath)) {
            $output->writeln("<error>JSON文件不存在：".$jsonFilePath."</error>");
            return;
        }
        
        // 读取并解析JSON文件
        $jsonContent = file_get_contents($jsonFilePath);
        $data = json_decode($jsonContent, true);
        
        if (json_last_error() !== JSON_ERROR_NONE) {
            $output->writeln("<error>JSON文件解析失败：".json_last_error_msg()."</error>");
            return;
        }
        
        // 检查数据结构
        if (!isset($data['data']) || !is_array($data['data'])) {
            $output->writeln("<error>JSON文件数据结构错误</error>");
            return;
        }
        
        $vulnerabilities = $data['data'];
        $output->writeln("<info>成功解析JSON文件，共 ".count($vulnerabilities)." 条漏洞数据</info>");
        
        // 开始导入数据
        $successCount = 0;
        $errorCount = 0;
        
        foreach ($vulnerabilities as $vul) {
            try {
                // 准备要插入的数据
                // 转换时间格式（ISO 8601到MySQL datetime）
                $firstFoundTime = $vul['first_found_time'] ?? null;
                $lastFoundTime = $vul['last_found_time'] ?? null;
                
                if ($firstFoundTime) {
                    $firstFoundTime = date('Y-m-d H:i:s', strtotime($firstFoundTime));
                }
                
                if ($lastFoundTime) {
                    $lastFoundTime = date('Y-m-d H:i:s', strtotime($lastFoundTime));
                }
                
                // 从title中提取或生成vul_name
                $vulName = $vul['title'] ?? '未知漏洞';
                if (strlen($vulName) > 255) {
                    $vulName = substr($vulName, 0, 255);
                }
                
                // 获取CVE ID
                $cveId = '';
                if (isset($vul['cve_item'])) {
                    $cveId = $vul['cve_item']['cve_id'] ?? '';
                    if (empty($cveId) && isset($vul['cve_item']['cve_id_list'])) {
                        $cveId = $vul['cve_item']['cve_id_list'][0] ?? '';
                    }
                }
                
                // 确保severity值符合数据库enum定义
                $severity = $vul['severity'] ?? 'SEVERITY_LOW';
                if (!in_array($severity, ['SEVERITY_CRITICAL', 'SEVERITY_HIGH', 'SEVERITY_MEDIUM', 'SEVERITY_LOW'])) {
                    $severity = 'SEVERITY_LOW';
                }
                
                $insertData = [
                    'result_id' => $vul['result_id'] ?? '',
                    'vul_id' => $vul['vul_id'] ?? '',
                    'vul_name' => $vulName,
                    'title' => $vul['title'] ?? '',
                    'tags' => isset($vul['tags']) ? json_encode($vul['tags']) : null,
                    'first_found_time' => $firstFoundTime,
                    'last_found_time' => $lastFoundTime,
                    'agent_id' => $vul['agent_id'] ?? '',
                    'os_type' => $vul['os_type'] ?? '',
                    'hostname' => $vul['hostname'] ?? '',
                    'ip' => $vul['ip'] ?? '',
                    'group_name' => $vul['group_name'] ?? '',
                    'agent_status' => $vul['agent_status'] ?? '',
                    'charger_name' => $vul['charger_name'] ?? '',
                    'cve_id' => $cveId,
                    'cwe_ids' => isset($vul['cve_item']['cwe_ids']) ? json_encode($vul['cve_item']['cwe_ids']) : null,
                    'cnvd_id' => $vul['cve_item']['cnvd_id'] ?? '',
                    'cnnvd_id' => $vul['cve_item']['cnnvd_id'] ?? '',
                    'poc_types' => isset($vul['poc_types']) ? json_encode($vul['poc_types']) : null,
                    'exec_type' => isset($vul['exec_type']) ? json_encode($vul['exec_type']) : null,
                    'run_level' => $vul['run_level'] ?? '',
                    'description' => $vul['description'] ?? '',
                    'solution' => $vul['solution'] ?? '',
                    'status' => 'pending',
                    'severity' => $severity, // 直接使用原始值，确保符合数据库enum定义
                    'raw_data' => json_encode($vul),
                    'created_at' => date('Y-m-d H:i:s'),
                    'updated_at' => date('Y-m-d H:i:s')
                ];
                
                // 使用ON DUPLICATE KEY UPDATE语法避免重复插入
                // 先检查是否存在该result_id的记录
                $exists = Db::table('asm_vulnerability_qingteng')
                    ->where('result_id', $insertData['result_id'])
                    ->count() > 0;
                
                if ($exists) {
                    // 更新现有记录
                    Db::table('asm_vulnerability_qingteng')
                        ->where('result_id', $insertData['result_id'])
                        ->update($insertData);
                } else {
                    // 插入新记录
                    Db::table('asm_vulnerability_qingteng')->insert($insertData);
                }
                
                $successCount++;
            } catch (\Throwable $e) {
                $output->writeln("<error>导入漏洞数据失败：".$e->getMessage()."</error>");
                $errorCount++;
            }
        }
        
        $output->writeln("<info>青藤云漏洞数据导入完成：成功 ".$successCount." 条，失败 ".$errorCount." 条</info>");
    }
    
    /**
     * 验证并确保青藤云severity格式符合数据库定义
     */
    private static function convertSeverity(string $severity): string
    {
        $validSeverities = ['SEVERITY_CRITICAL', 'SEVERITY_HIGH', 'SEVERITY_MEDIUM', 'SEVERITY_LOW'];
        return in_array($severity, $validSeverities) ? $severity : 'SEVERITY_LOW';
    }
}